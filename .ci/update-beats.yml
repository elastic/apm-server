---
name: Bump beats
title: "[automation] update libbeat and beats packaging"

scms:
  apm-server:
    kind: github
    spec:
      user: '{{ requiredEnv "GIT_USER" }}'
      email: '{{ requiredEnv "GIT_EMAIL" }}'
      owner: elastic
      repository: apm-server
      token: '{{ requiredEnv "GITHUB_TOKEN" }}'
      username: '{{ requiredEnv "GIT_USER" }}'
      branch: '{{ requiredEnv "BRANCH_NAME" }}'

actions:
  apm-server-pr:
    kind: github/pullrequest
    scmid: apm-server
    spec:
      title: "[automation] update libbeat and beats packaging"
      automerge: false
      labels:
        - automation
        - backport-skip

sources:
  beats:
    kind: json
    spec:
      file: 'https://api.github.com/repos/elastic/beats/commits?sha=main&per_page=1'
      key: '.[0].sha'

conditions:
  beats-version-check:
    name: Check beats version
    kind: shell
    sourceid: beats
    spec:
      command: .ci/scripts/check-beats-version.sh
      environments:
        - name: BRANCH_NAME

targets:
  beats:
    name: Update beats
    sourceid: beats
    scmid: apm-server
    kind: shell
    spec:
      command: .ci/scripts/update-beats.sh
      environments:
        - name: PATH
        - name: GOPATH
        - name: HOME


