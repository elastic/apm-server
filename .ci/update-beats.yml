---
name: Bump beats
title: "[automation] update libbeat and beats packaging"

scms:
  apm-server:
    kind: github
    spec:
      user: '{{ requiredEnv "GIT_USER" }}'
      email: '{{ requiredEnv "GIT_EMAIL" }}'
      owner: reakaleek
      repository: apm-server
      token: '{{ requiredEnv "GITHUB_TOKEN" }}'
      username: '{{ requiredEnv "GIT_USER" }}'
      branch: '{{ requiredEnv "BRANCH_NAME" }}'

actions:
  apm-server-pr:
    kind: github/pullrequest
    scmid: apm-server
    spec:
      title: "[automation] update libbeat and beats packaging"
      automerge: false
      labels:
        - automation
        - backport-skip

sources:
  beats:
    kind: file
    spec:
      file: 'https://github.com/elastic/beats/commit/{{ requiredEnv "BRANCH_NAME" }}.patch'
      matchpattern: "^From\\s([0-9a-f]{40})\\s"

conditions:
  beats-version-check:
    name: Check beats version
    kind: shell
    sourceid: beats
    spec:
      command: grep "BEATS_VERSION?={{ requiredEnv "BRANCH_NAME" }}" Makefile

targets:
  beats:
    name: Update beats
    sourceid: beats
    scmid: apm-server
    kind: shell
    spec:
      command: .ci/scripts/update-beats.sh
      environments:
        - name: PATH
        - name: GOPATH
        - name: HOME


