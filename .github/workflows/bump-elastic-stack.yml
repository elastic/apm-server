---
name: bump-elastic-stack-snapshot

on:
  schedule:
    - cron: '0 15 * * 1-5'
  pull_request:
  push:

permissions:
  pull-requests: write
  contents: write

jobs:
  ## TODO: provide composite action that provides the current active branches
  filter:
    runs-on: ubuntu-latest
    timeout-minutes: 1
    outputs:
      matrix: ${{ steps.generate.outputs.matrix }}
    steps:
      - id: generator
        shell: python
        run: |
          import json
          import os
          import requests
          r = requests.get(url='https://storage.googleapis.com/artifacts-api/snapshots/branches.json')
          matrix = {'include': []}
          for branch in r.json()['branches']:
            matrix['include'].append({"branch": branch})
          with open(os.environ.get('GITHUB_OUTPUT'), "a") as f:
            f.write("matrix={}\n".format(json.dumps(matrix)))
      - id: debug
        run: echo "The branches are ${{ fromJSON(steps.generator.outputs.matrix) }}"

  branches:
    runs-on: ubuntu-latest
    needs: [filter]
    strategy:
      matrix: ${{ fromJson(needs.filter.outputs.matrix) }}
    steps:
      - run: echo ${{ matrix.branch }}
