# Run soak test workers

**NOTE: This is unlikely to be useful for non-Elastic employees**

This folder provides tools to enable creation of workers which have the capability to send load to any APM Server. The worker's main purpose is to generate events for soak testing APM Server.

## Dependencies

- `terraform`
- `gcloud CLI`

## Pre-requisites

1. Install terraform
2. Make sure that you have access to the GCP project and have enough privileges to create and manage instances
3. Install [gcloud CLI](https://cloud.google.com/sdk/docs/install)
4. Authenticate with GCP by running `gcloud auth application-default login`

For full guide refer to the official getting started guide for google provider [here](https://registry.terraform.io/providers/hashicorp/google/latest/docs/guides/getting_started)

## NOTE for testing

The project utilizes [terraform workspaces](https://www.terraform.io/language/state/workspaces) to manage states for different ESS clusters. Production deployment uses `production` workspace. For testing against a non-production ESS cluster or APM-Server instances make sure to use a custom workspace. Workspaces can be created using:

```bash
terraform workspace new <workspace_name>
```

## Usage

1. To work with production cluster select production namespace using `make use-production`. Once the production workspace is selected any changes will affect the workers sending load on soak test clusters. For any other use-case please create a separate workspace.
2. Generate apmsoak binary to use with the workers using `make apmsoak`.
2. A sample variables file can be generated by using `make terraform.tfvars`, make sure to update the values to refer to the production configurations.
3. Check the diff of the update/create using `make plan`and apply the changes using `make apply`.
