# Run soak test worker

**NOTE: This is unlikely to be useful for non-Elastic employees**

This folder provides tools to enable creation of a worker instance to send load to any APM Server. The worker runs the `apmsoak` binary to generate a continuous load and since it is a long running process, it is run as systemd unit configured to restart on failure. Monitoring is also setup for the worker as part of the terraform module to monitor the node resources and the systemd unit status.

## Dependencies

- `terraform`
- `gcloud CLI`

## Pre-requisites

1. Install terraform
2. Create a GCS bucket named `apmsoak-tf` on the target project to serve as a backend
2. Make sure that you have access to the GCP project and have enough privileges to create and manage instances. A set of required roles to be able to create worker using this module are:
    a. `Storage Object Admin` on the backend bucket
    b. `Compute Network Admin`
    c. `Compute Security Admin`
    d. `Create Service Accounts`
    e. `Delete Service Accounts`
    f. `Compute Instance Admin (v1)`
    g. `Service Account User` if service account is used
3. Install [gcloud CLI](https://cloud.google.com/sdk/docs/install)
4. Authenticate with GCP by running `gcloud auth application-default login`

For full guide refer to the official getting started guide for terraform google provider [here](https://registry.terraform.io/providers/hashicorp/google/latest/docs/guides/getting_started).

## NOTE for testing

The project utilizes [terraform workspaces](https://www.terraform.io/language/state/workspaces) to manage states for different worker deployments. Production deployment uses `production` workspace. For testing against a non-production ESS cluster or APM-Server instances make sure to use a custom workspace. Custom workspaces can be created using `terraform workspace new <workspace_name>`.

## Usage

1. To work with production cluster select production namespace using `make use-production`. Once the production workspace is selected any changes will affect the workers sending load on soak test clusters. For any other use-case please create a separate workspace.
2. Generate `apmsoak` binary to use with the worker using `make apmsoak`.
3. Create terraform tfvars file to provide the required configuration to generate the worker. A sample variables file can be generated by using `make terraform.tfvars`. A copy of current production configuration can be downloaded using `gsutil cp gs://apmsoak-tf/tfvars/production.tfvars terraform.tfvars`.
4. Finally, check the diff of the update/create using `make plan` and apply the changes using `make apply`.

### A quick guide to update production worker settings

```bash
# Switch to use production workspace
$ make use-production

# Get the current tfvars file and update any required settings
$ gsutil cp gs://apmsoak-tf/tfvars/production.tfvars terraform.tfvars

# View the diff
$ make plan

# Apply the diff
$ make apply
```
