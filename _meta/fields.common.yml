- key: apm
  title: General APM
  description: >
    Fields common to various APM events.
  fields:
    - name: listening
      type: keyword
      description: >
        Address the server is listening on.
    - name: processor.name
      type: keyword
      description: Processor name.

    - name: processor.event
      type: keyword
      description: Processor event.

    - name: timestamp
      type: group
      fields:
        - name: us
          type: long
          count: 1
          description: >
            Timestamp of the event in microseconds since Unix epoch.

    - name: context
      type: group
      description: >
        Any arbitrary contextual information regarding the event, captured by the agent, optionally provided by the user.
      dynamic: false
      fields:
        - name: custom
          type: object
          enabled: false
          indexed: false
          analyzed: false
          searchable: false
          aggregatable: false

        - name: db
          type: group
          fields:
            - name: instance
              type: keyword
              index: false
              analyzed: false
              searchable: false
              aggregatable: false

            - name: statement
              type: keyword
              index: false
              analyzed: false
              searchable: false
              aggregatable: false

            - name: type
              type: keyword
              index: false
              analyzed: false
              searchable: false
              aggregatable: false

            - name: user
              type: keyword
              index: false
              analyzed: false
              searchable: false
              aggregatable: false

        - name: http
          type: group
          dynamic: false
          fields:
            - name: method
              type: keyword
              index: false
              aggregatable: false
              searchable: false
              doc_values: false

            - name: status_code
              type: long
              description: >
                The status code of the http response.

            - name: url
              type: keyword
              index: false
              aggregatable: false
              searchable: false
              doc_values: false

        - name: tags
          type: object
          object_type: keyword
          dynamic: true
          description: >
            A flat mapping of user-defined tags with string values.

        - name: user
          type: group
          fields:

          - name: username
            type: keyword
            description: >
              The username of the logged in user.

          - name: id
            type: keyword
            description: >
              Identifier of the logged in user.

          - name: email
            type: keyword
            description: >
              Email of the logged in user.

          - name: ip
            type: ip
            description: >
              IP of the user where the event is recorded, typically a web browser.
              This is obtained from the X-Forwarded-For header, of which the first entry is the IP of the original client.
              This value however might not be necessarily trusted, as it can be forged by a malicious user.

          - name: user-agent
            type: text
            description: >
              Software agent acting in behalf of a user, eg. a web browser / OS combination.

        - name: request
          type: group
          fields:

          - name: body
            type: object
            enabled: false
            indexed: false
            analyzed: false
            searchable: false
            aggregatable: false

          - name: cookies
            type: object
            enabled: false
            indexed: false
            analyzed: false
            searchable: false
            aggregatable: false

          - name: headers
            type: object
            enabled: false
            indexed: false
            analyzed: false
            searchable: false
            aggregatable: false
            # intake enforces:
            # fields:
            # - name: content-type
            #   type: keyword
            # - name: cookie
            #   type: keyword
            # - name: user-agent
            #   type: keyword

          - name: env
            type: object
            enabled: false
            indexed: false
            analyzed: false
            searchable: false
            aggregatable: false

          - name: socket
            type: object
            enabled: false
            indexed: false
            analyzed: false
            searchable: false
            aggregatable: false
            # intake enforces:
            # fields:
            # - name: socket.encrypted
            #   type: boolean
            # - name: socket.remote_address
            #   type: keyword

          - name: url
            type: group
            description: >
              A complete Url, with scheme, host and path.
            fields:

              - name: raw
                type: keyword
                description: >
                  The raw, unparsed URL of the request, e.g https://example.com:443/search?q=elasticsearch#top.

              - name: protocol
                type: keyword
                description: >
                  The protocol of the request, e.g. "https:".

              - name: full
                type: keyword
                description: >
                  The full, possibly agent-assembled URL of the request, e.g https://example.com:443/search?q=elasticsearch#top.

              - name: hostname
                type: keyword
                description: >
                  The hostname of the request, e.g. "example.com".

              - name: port
                type: keyword
                description: >
                  The port of the request, e.g. 443.

              - name: pathname
                type: keyword
                description: >
                  The path of the request, e.g. "/search".

              - name: search
                type: keyword
                description: >
                  The search describes the query string of the request, e.g. "q=elasticsearch".

              - name: hash
                type: keyword
                description: >
                  The hash of the request URL, e.g. "top".

          - name: http_version
            type: keyword
            description: >
              The http version of the request leading to this event.

          - name: method
            type: keyword
            description: >
              The http method of the request leading to this event.

        - name: response
          type: group
          fields:

          - name: headers
            type: object
            enabled: false
            indexed: false
            analyzed: false
            searchable: false
            aggregatable: false
            # intake enforces:
            # fields:
            # - name: content-type
            #   type: keyword
            # - name: user-agent
            #   type: keyword

          - name: headers_sent
            type: boolean
            index: false
            aggregatable: false

          - name: status_code
            type: long
            description: >
              The http status code of the response, eg. '200'.

          - name: finished
            type: boolean
            description: >
              A boolean indicating whether the response was finished or not.

        - name: system
          type: group
          description: >
            Optional system fields.
          fields:

            - name: hostname
              type: keyword
              description: >
                The hostname of the system the event was recorded on.

            - name: architecture
              type: keyword
              description: >
                The architecture of the system the event was recorded on.

            - name: platform
              type: keyword
              description: >
                The platform of the system the event was recorded on.

            - name: ip
              type: ip
              description: >
                IP of the host that records the event.

        - name: process
          type: group
          description: >
            Information pertaining to the running process where the data was collected
          fields:
            - name: argv
              type: object
              enabled: false
              indexed: false
              analyzed: false
              searchable: false
              aggregatable: false

            - name: pid
              type: long
              description: >
                Numeric process ID of the service process.

            - name: ppid
              type: long
              description: >
                Numeric ID of the service's parent process.

            - name: title
              type: keyword
              description: >
                Service process title.

        - name: service
          type: group
          description: >
            Service fields.
          fields:
            - name: name
              type: keyword
              description: >
                Immutable unique name of the service emitting this event.
              format: url
              label_template: "{{value}}"
              open_link_in_current_tab: true
              url_template:
                - min_version: "5.0.0"
                  value: "../app/kibana#/dashboard/41b5d920-7821-11e7-8c47-65b845b5cfb3?_a=(query:(query_string:(analyze_wildcard:!t,query:'context.service.name:%22{{value}}%22')))"
                - min_version: "6.0.0-alpha1"
                  value: "../app/kibana#/dashboard/41b5d920-7821-11e7-8c47-65b845b5cfb3?_a=(query:(language:lucene,query:'context.service.name:\"{{value}}\"'))"

            - name: version
              type: keyword
              description: >
                Version of the service emitting this event.

            - name: environment
              type: keyword
              description: >
                Service environment.

            - name: language
              type: group
              fields:

              - name: name
                type: keyword
                description: >
                  Name of the programming language used.

              - name: version
                type: keyword
                description: >
                  Version of the programming language used.

            - name: runtime
              type: group
              fields:

              - name: name
                type: keyword
                description: >
                  Name of the runtime used.

              - name: version
                type: keyword
                description: >
                  Version of the runtime used.

            - name: framework
              type: group
              fields:

              - name: name
                type: keyword
                description: >
                  Name of the framework used.

              - name: version
                type: keyword
                description: >
                  Version of the framework used.

            - name: agent
              type: group
              fields:

              - name: name
                type: keyword
                description: >
                  Name of the agent used.

              - name: version
                type: keyword
                description: >
                  Version of the agent used.

    - name: transaction
      type: group
      dynamic: false
      fields:
        - name: id
          type: keyword
          description: >
            The transaction ID.
          format: url
          label_template: "View Spans"
          open_link_in_current_tab: true
          url_template:
            - min_version: 5.0.0
              value: "../app/kibana#/dashboard/3e3de700-7de0-11e7-b115-df9c90da2df1?_a=(query:(query_string:(analyze_wildcard:!t,query:'transaction.id:%22{{value}}%22')))"
            - min_version: 6.0.0-alpha1
              value: "../app/kibana#/dashboard/3e3de700-7de0-11e7-b115-df9c90da2df1?_a=(query:(language:lucene,query:'transaction.id:{{value}}'))"
        - name: sampled
          type: boolean
          description: >
            Transactions that are 'sampled' will include all available information. Transactions that are not sampled will not have spans or context.

    - name: trace 
      type: group
      dynamic: false
      fields:
        - name: id
          type: keyword
          description: >
             The ID of the trace to which the event belongs to.

    - name: parent 
      type: group
      dynamic: false
      fields:
        - name: id
          type: keyword
          description: >
             The ID of the parent event.

    # ECS
    - name: agent
      type: group
      dynamic: false
      fields:
        - name: name
          type: alias
          path: context.service.agent.name

        - name: version
          type: alias
          path: context.service.agent.version

    - name: client
      type: group
      dynamic: false
      fields:
        - name: ip
          type: alias
          path: context.user.ip

    - name: observer
      type: group
      dynamic: false
      fields:
        - name: hostname
          type: alias
          path: beat.hostname

        - name: listening
          type: alias
          path: listening

        - name: type
          type: alias
          path: beat.name

        - name: version
          type: alias
          path: beat.version

    - name: host
      type: group
      dynamic: false
      fields:
        - name: architecture
          type: alias
          path: context.system.architecture

        - name: ip
          type: alias
          path: context.system.ip

        - name: hostname
          type: alias
          path: context.system.hostname

        - name: os
          type: group
          fields:
            - name: platform
              type: alias
              path: context.system.platform

    - name: http
      type: group
      dynamic: false
      fields:
        - name: request.method
          type: alias
          path: context.request.method

        - name: response.finished
          type: alias
          path: context.response.finished

        - name: response.status_code
          type: alias
          path: context.response.status_code

        - name: version
          type: alias
          path: context.request.http_version

    - name: process
      type: group
      dynamic: false
      fields:
        - name: pid
          type: alias
          path: context.process.pid

        - name: ppid
          type: alias
          path: context.process.ppid

        - name: title
          type: alias
          path: context.process.title

    - name: service
      type: group
      dynamic: false
      fields:
        # not in ECS
        - name: environment
          type: alias
          path: context.service.environment

        # not in ECS
        - name: framework
          type: group
          fields:
            - name: name
              type: alias
              path: context.service.framework.name

            - name: version
              type: alias
              path: context.service.framework.version

        # not in ECS
        - name: language
          type: group
          fields:
            - name: name
              type: alias
              path: context.service.language.name

            - name: version
              type: alias
              path: context.service.language.version

        - name: name
          type: alias
          path: context.service.name

        # not in ECS
        - name: runtime
          type: group
          fields:
            - name: name
              type: alias
              path: context.service.runtime.name

            - name: version
              type: alias
              path: context.service.runtime.version

        - name: version
          type: alias
          path: context.service.version

    - name: url
      type: group
      dynamic: false
      fields:
        - name: domain
          type: alias
          path: context.request.url.hostname

        - name: fragment
          type: alias
          path: context.request.url.hash

        - name: full
          type: alias
          path: context.request.url.full

        - name: original
          type: alias
          path: context.request.url.raw

        - name: path
          type: alias
          path: context.request.url.pathname

        # context.request.url.port keyword -> long
        - name: port
          type: long
          description: >
            The port of the request, e.g. 443.

        - name: query
          type: alias
          path: context.request.url.search

        # context.request.url.protocol minus the ":"
        - name: scheme
          type: keyword
          description: >
            The scheme of the request, e.g. "https".

    - name: user
      type: group
      dynamic: false
      fields:
        - name: email
          type: alias
          path: context.user.email

        - name: id
          type: alias
          path: context.user.id

        - name: name
          type: alias
          path: context.user.username

    - name: user_agent.original.text
      type: alias
      path: context.user.user-agent
