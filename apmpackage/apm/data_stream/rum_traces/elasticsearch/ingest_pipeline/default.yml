---
description: Pipeline for ingesting APM RUM trace events.
processors:
  - pipeline:
      name: observer_version
  - pipeline:
      name: observer_ids
  - pipeline:
      name: ecs_version
  - pipeline:
      name: user_agent
  - pipeline:
      name: client_geoip
  - set:
      if: ctx.transaction?.type != null
      field: processor.event
      value: transaction
  - set:
      if: ctx.span?.type != null
      field: processor.event
      value: span
  - pipeline:
      name: event_duration
  - remove:
      # Remove some metadata from spans that is available in the parent transaction, to cut down on storage costs.
      if: ctx.processor?.event == 'span'
      field:
        - host
        - process
        - user
        - user_agent
        - container
        - kubernetes
        - service.node
        - service.version
        - service.language
        - service.runtime
        - service.framework
      ignore_missing: true
      ignore_failure: true
  - script:
      lang: painless
      source: |
        def representative_count = ctx?.span?.representative_count != null ? ctx?.span?.representative_count : ctx?.transaction?.representative_count;
          
        if(representative_count == null) {
        return;
        }
        
        int doc_count = (int)representative_count;
        
        double decimal = representative_count - doc_count;
        
        if (decimal > Math.random()) {
        doc_count += 1;
        }
        
        ctx._doc_count = doc_count;

